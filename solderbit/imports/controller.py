from microbit import *
import struct
import ssd1306

epd_bitmap_BOOT_SCREEN = bytearray([
    0x00, 0x00, 0xc0, 0xe0, 0xf0, 0xf0, 0x70, 0x70, 0x70, 0xf0, 0xf0, 0xe0, 0x40, 0x00, 0x00, 0x00, 
	0xe0, 0xf0, 0xf0, 0xf0, 0xf0, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0x70, 0xf0, 0xf0, 
	0xf0, 0xf0, 0xc0, 0x00, 0x00, 0xf0, 0xf0, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xe0, 0xe0, 0xc0, 
	0xc0, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 
	0xf0, 0xf0, 0xf0, 0x60, 0x00, 0x00, 0x00, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 0xf0, 
	0xe0, 0xe0, 0xc0, 0x80, 0x00, 0x00, 0x00, 0xe0, 0xf0, 0xf0, 0xe0, 0x00, 0x00, 0x20, 0xf0, 0xf0, 
	0xf0, 0xc0, 0x80, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xc0, 0xe0, 0xf0, 0xf0, 0x70, 0x00, 0x00, 
	0x00, 0x00, 0x0f, 0x1f, 0x1f, 0x3f, 0x38, 0x78, 0x70, 0x70, 0xf0, 0xf0, 0xe0, 0xc0, 0x00, 0x00, 
	0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 
	0xff, 0xff, 0xff, 0x00, 0x00, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x01, 0x03, 0x8f, 
	0xff, 0xff, 0xfe, 0x30, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x78, 0x70, 0x70, 0x70, 0x70, 0x70, 
	0x70, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xc0, 0xc0, 0xc0, 0xe0, 0xe0, 
	0xf1, 0xff, 0xff, 0x3f, 0x04, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x01, 
	0x03, 0x87, 0xcf, 0xff, 0xfe, 0xfc, 0xfc, 0xfe, 0xff, 0xcf, 0x87, 0x03, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x0e, 0x1e, 0x3e, 0x3c, 0x38, 0x38, 0x38, 0x38, 0x3f, 0x3f, 0x1f, 0x07, 0x00, 0x00, 
	0x1f, 0x3f, 0x3f, 0x3f, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x3f, 
	0x3f, 0x3f, 0x1f, 0x00, 0x00, 0x3f, 0x3f, 0x3f, 0x3c, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 0x38, 
	0x30, 0x00, 0x00, 0x00, 0x3f, 0x3f, 0x3f, 0x3f, 0x38, 0x38, 0x38, 0x38, 0x3c, 0x3c, 0x3e, 0x1f, 
	0x0f, 0x07, 0x01, 0x00, 0x00, 0x00, 0x1f, 0x3f, 0x3f, 0x3f, 0x3c, 0x38, 0x38, 0x38, 0x38, 0x38, 
	0x38, 0x38, 0x38, 0x38, 0x00, 0x00, 0x00, 0x3f, 0x3f, 0x3f, 0x1f, 0x01, 0x01, 0x01, 0x01, 0x03, 
	0x0f, 0x3f, 0x3f, 0x3c, 0x10, 0x00, 0x00, 0x3f, 0x3f, 0x3f, 0x3f, 0x00, 0x00, 0x10, 0x3c, 0x3e, 
	0x3f, 0x1f, 0x0f, 0x03, 0x01, 0x00, 0x01, 0x01, 0x07, 0x0f, 0x1f, 0x3e, 0x3c, 0x38, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xf8, 0xfc, 
	0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xc0, 0x00, 0x00, 0x00, 0x80, 0xfe, 0xfe, 0xfe, 0xfe, 
	0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0x80, 0x00, 0x00, 0x00, 0x80, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 0xfe, 
	0xfe, 0xfe, 0xfc, 0xf0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x83, 0x83, 
	0x83, 0x83, 0x83, 0x87, 0xc7, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xc7, 0x83, 0x83, 
	0x83, 0x83, 0x83, 0x83, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xe0, 0xe0, 
	0xe0, 0xe0, 0xe0, 0xe0, 0xf1, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xf1, 0xe0, 0xe0, 
	0xe0, 0xe0, 0xe0, 0xe0, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x1f, 0x3f, 
	0x3f, 0x7f, 0x7f, 0x7f, 0x7f, 0x7f, 0x7f, 0x03, 0x00, 0x00, 0x00, 0x01, 0x7f, 0x7f, 0x7f, 0x7f, 
	0x7f, 0x7f, 0x7f, 0x7f, 0x7f, 0x01, 0x00, 0x00, 0x00, 0x01, 0x7f, 0x7f, 0x7f, 0x7f, 0x7f, 0x7f, 
	0x7f, 0x3f, 0x1f, 0x0f, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
	0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
])

_CONTROLLER_DATA_ID = 0x1234
_controller_data_format = "4hi"

_J1X_OFFSET = 0
_J1Y_OFFSET = 0
_J2X_OFFSET = 0
_J2Y_OFFSET = 0
_offsets = []

power_button = pin2
off_button = pin14

JOY_X1 = 0b0000
JOY_Y1 = 0b0001
JOY_X2 = 0b0010
JOY_Y2 = 0b0011
JOY1_BTN = 0b0100
JOY2_BTN = 0b0101
R1_BTN = 0b0110
L1_BTN = 0b0111
LEFT_UP_BTN = 0b1000
LEFT_DOWN_BTN = 0b1001
LEFT_RIGHT_BTN = 0b1010
LEFT_LEFT_BTN = 0b1011
RIGHT_UP_BTN = 0b1100
RIGHT_DOWN_BTN = 0b1101
RIGHT_RIGHT_BTN = 0b1110
RIGHT_LEFT_BTN = 0b1111

oled_width = 128
oled_height = 64

try:
    oled = ssd1306.SSD1306_I2C(oled_width, oled_height, i2c.i2c)
except:
    print("No OLED on device!")

_buzzer_plus = pin15
_buzzer_minus = pin16

def read_input(input, offset=True):
    pin = None
    value = input&1
    pin15.write_digital(value);

    value = (input>>1)&1
    pin8.write_digital(value);

    value = (input>>2)&1
    pin16.write_digital(value);

    value = (input>>3)&1
    sleep(1) #give some time for the mux to change channel

    if value == 0:
        pin = pin0
    else:
        pin = pin1
    
    if input > 3:
        value =  not pin.read_digital()
    else:
        value = pin.read_analog() if offset is False else (int(pin.read_analog()) - _offsets[input&3])
        value = min(1023>>1, max(-1023>>1, value))

    return value


for num in range(10):
    _J1X_OFFSET = _J1X_OFFSET + read_input(JOY_X1, False)
    _J1Y_OFFSET = _J1Y_OFFSET + read_input(JOY_Y1, False)
    _J2X_OFFSET = _J2X_OFFSET + read_input(JOY_X2, False)
    _J2Y_OFFSET = _J2Y_OFFSET + read_input(JOY_Y2, False)

_J1X_OFFSET = int(_J1X_OFFSET/10)
_J1Y_OFFSET = int(_J1Y_OFFSET/10)
_J2X_OFFSET = int(_J2X_OFFSET/10)
_J2Y_OFFSET = int(_J2Y_OFFSET/10)

_offsets.append(_J1X_OFFSET)
_offsets.append(_J1Y_OFFSET)
_offsets.append(_J2X_OFFSET)
_offsets.append(_J2Y_OFFSET)

try:
    oled.bitmap(epd_bitmap_BOOT_SCREEN, 0, 0,128,64)
    oled.show()
    sleep(1850)
except:
    print("Skipping logo")
    

def read_all_inputs():
    output = []
    for input in range(16):
        output.append(read_input(input))
    return output


def read_encoded():
    output = bytearray()
    data_tmp = read_all_inputs()
    data = data_tmp[0:4]
    bools = 0
    for idx, value in enumerate(data_tmp[4:]):
        bools |= value<<idx 
    data.append(bools)
    output = struct.pack(_controller_data_format, *data)
    print(data_tmp)
    return output


def data_decode(data):
    if data == None:
        return None
    
    data = list(struct.unpack(_controller_data_format, data))
    decoded_data = data[0:4]

    output = []
    for num in range(12):
        output.append(bool((data[4]>>num)&1))

    decoded_data += output

    return decoded_data


def text_x_center(string, y):
    oled.text(string, 64-(len(string)*4), y)


def _print_device(device, num, max):
    oled.fill(0)

    text_x_center("Device List", 1)
    oled.line(0,10,128,10,1)
    text_x_center(device["name"], 25)
    text_x_center(device["addr"].hex(), 35)
    oled.line(0,53,128,53,1)
    text_x_center(f"{num+1}/{max}", 56)
    
    oled.show()

idx = 0
prev_press = 0

def show_devices(devices):
    global idx
    num_of_devs = len(devices)
    global prev_press

    try:
        idx %= num_of_devs

        if read_input(L1_BTN) == True and prev_press == 0:
            idx -= 1
            prev_press = 1
        elif read_input(L1_BTN) == False and prev_press == 1:
            prev_press = 0

        if read_input(R1_BTN) == True and prev_press == 0:
            idx += 1
            prev_press = 2
        elif read_input(R1_BTN) == False and prev_press == 2:
            prev_press = 0

        idx %= num_of_devs
        _print_device(devices[idx%len(devices)], idx, num_of_devs)

        if power_button.read_digital() == False:
            sleep(250)
            while power_button.read_digital() == False:
                pass
            device_id = idx
            idx = 0
            prev_press = 0
            show_connected_device(devices[device_id]["name"])
            return devices[device_id] 
    except:
        no_devices()
        return None
    
    oled.show()
    return None


def show_connected_device(name):
    oled.fill(0)
    text_x_center("Connected to:", 0)
    text_x_center(f"{name}", 10)
    text_x_center("Press red button", 30)
    text_x_center("to disconnect...", 40)
    oled.show()


def show_logo():
    oled.fill(0)
    oled.bitmap(epd_bitmap_BOOT_SCREEN, 0, 0,128,64)
    oled.show()


_time_next = 0
_cycles = 0
_out_text = 0
def no_devices():
    global _time_next
    global _cycles
    global _out_text
    oled.fill(0)
    output_text = ["Searching", "Scanning", "Detecting", "Finding", "Sniffing", "Seeking", "Pursuing", "Hunting"]
    symbols = ['....','o...', 'Oo..','0Oo.', '00Oo','000O','0000','O000','oO00', '.oO0', '..oO', '...o', '....']

    if running_time() > _time_next:
        _time_next = running_time() + 40
        _cycles = (_cycles + 1)
        if _cycles%120 == 0:
            _out_text = (_out_text+1)

    text_x_center(output_text[_out_text%len(output_text)], 20)
    text_x_center("Devices", 30)
    text_x_center(symbols[_cycles%len(symbols)], 40)
    oled.show()


def buzzer_sound(tone, freq=None):
    _buzzer_minus.write_analog(tone)

_time_next_2 = 0
_cycles_2 = 0
def power_down():
    global _time_next_2
    global _cycles_2

    if power_button.read_digital() == True:
        _cycles_2 = 0
        _time_next_2 = running_time() + 1000

    if running_time() > _time_next_2:
        _cycles_2 += 1
        _time_next_2 = running_time() + 1000
        if _cycles_2 == 2:
            oled.fill(0)
            text_x_center("Turning off", 20) 
            text_x_center("Release Button", 40)       
            oled.show()
            while power_button.read_digital() == False:
                pass
            off_button.write_digital(1)


def display_exists():
    return oled.exists




    
